Это статья про то, что такое майнинг (на примере сети Биткойн). (А это [homepage link](https://github.com/snordenstorm/wiki/wiki/My-Ethereum-Homepage) на всякий случай.)

#### Почему печатный станок — это печалька

Одним из ключевых свойств протокола Биткойн, благодаря которым он вообще получил признание, является невозможность "включить печатный станок", как это делают центробанки всех стран, и допечатать "на олимпиаду", "на Крым" и так далее. Ибо при каждом включении печатного станка обесцениваются те деньги, которые находятся у вас, дорогие сограждане, в руке/под подушкой/в банке. 

Поясним на коротком примере. Пусть на планете Плюк жило четыре человека, и у каждого было по 100$. Соответственно, каждый из них мог купить четверть всех богатств планеты Плюк, так как каждый из них является владельцем 100$, а суммарное количество долларов на планете было равно 400. Теперь банкир взял и допечатал себе ещё 400 долларов. У банкира стало 500 долларов, а у остальных троих осталось по 100. Таким образом, теперь банкир может купить 5/8 богатств планеты, а остальные трое — только по 1/8, в то время как до действий банкира они могли купить 1/4. Заметим, что с тем же успехом он мог превратиться в бандита, напасть на каждого из этих троих и отнять у каждого по 50$ — тогда бы у банкира (теперь уже бандита) стало 250$, а у всех остальных осталось по 50$ (и снова то же соотношение — 5/8 всех денежных запасов у бандита, по 1/8 у остальных). Экономически между допечатыванием 400$ и физическим грабежом каждого из жителей на 50$ нет никакой разницы (в этой ситуации), вот что я хочу сказать.

#### Биткойн — это избавление от [самого болезненного и самого незаметного налога](http://bitnovosti.files.wordpress.com/2014/02/durov-twit.png)

Так вот в сети Биткойн никто не может "прийти и допечатать сколько нужно" (хотя бы потому, что эта сеть является полностью децентрализованной и никем не контролируется). Выпуск биткойнов является строго плановым, гораздо более плановым даже, чем советская экономика, потому что алгоритм раз и навсегда прописан в протоколе Биткойн-сети (что-то, что является куском программного кода, всегда является более плановым, чем советская экономика). Раз в две недели т.н. сложность майнинга автоматически пересчитывается так, чтобы независимо от суммарной мощности участвующих устройств каждый новый блок кому-либо из майнеров этой замечательной планеты удавалось подписать в среднем раз в 10 минут. (О том, что такое сложность майнинга, блок, и зачем его подписывать, сказано [чуть дальше](https://github.com/snordenstorm/wiki/wiki/%D0%9C%D0%B0%D0%B9%D0%BD%D0%B8%D0%BD%D0%B3-%D0%B1%D0%B8%D1%82%D0%BA%D0%BE%D0%B9%D0%BD%D0%BE%D0%B2#%D0%A7%D1%82%D0%BE-%D0%B5%D1%81%D1%82%D1%8C-%D0%BC%D0%B0%D0%B9%D0%BD%D0%B8%D0%BD%D0%B3-%D0%BD%D0%B0-%D1%81%D0%B0%D0%BC%D0%BE%D0%BC-%D0%B4%D0%B5%D0%BB%D0%B5).)   Как результат, скорость выпуска биткойнов строго детерминирована. Выплата за подписание блока в первые 4 года составляла 50 BTC; в последующие 4 года (и поныне, т.к. блокчейн сети Биткойн был запущен 3 января 2009 года) [она "уполовинивается"](https://en.bitcoin.it/wiki/Controlled_supply#Projected_Bitcoins_Short_Term) и составляет 25 BTC; в последующие 4 года it also would halve и составит 12.5 BTC, и так далее. 

(На самом деле "4 года" здесь везде надо заменять на "210000 блоков". Поскольку 1 блок удаётся подписать в среднем раз в 10 минут, в час удаётся подписать в среднем 6 блоков, в сутки — 144, в год — 52560, и, наконец, матожидание количества подписанных блоков за 4 года — 210240. Про 4 года говорят для удобства, потому что это более наглядно, чем верное значение в 210000 блоков, прописанное в протоколе.) 

Выплаты за подписание блока являются выплатами "из ниоткуда", и это и есть единственный способ эмиссии (появления новых монет). Достаточно справедливо — каждая такая выплата достаётся человеку, который потратил на майнинг вычислительные мощности своих устройств и оплатил немалые порой счета за электричество.

Посчитаем количество всех биткойнов, которые когда-либо будут выпущены. Ещё раз, в первые 4 года каждая награда составила 50 BTC, во вторые 4 года каждая награда составит 25 BTC... Всего получается

210000 ⋅ 50 + 210000 ⋅ 25 + 210000 ⋅ 12.5 + ... = 210000 ⋅ (50 + 25 + 12.5 + ...).

В скобках получилась геометрическая прогрессия (привет, школа!). Сумма бесконечной геометрической прогрессии, [как мы помним](https://ru.wikipedia.org/wiki/%D0%93%D0%B5%D0%BE%D0%BC%D0%B5%D1%82%D1%80%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B0%D1%8F_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B5%D1%81%D1%81%D0%B8%D1%8F#.D0.A1.D0.B2.D0.BE.D0.B9.D1.81.D1.82.D0.B2.D0.B0), равна b<sub>0</sub>/(1-q), где b<sub>0</sub> — начальный элемент прогрессии (в нашем случае 50), а q — множитель её (в нашем случае 1/2). Таким образом, полностью благодаря школьной математике, 50 + 25 + 12.5 + ... = 100, и полная сумма всех биткойнов, которые когда-либо будут выпущены, равна 210000 ⋅ 100 = 21000000 = 21 million BTC.

Мы получили, что число биткойнов ограничено самим протоколом, и скорость их добычи тоже жёстко задана протоколом. Биткойнов никогда не будет больше, чем 21 миллион — за то и любим. При всём [сумасшедшем росте](https://blockchain.info/ru/charts/difficulty?timespan=all&showDataPoints=false&daysAverageString=1&show_header=true&scale=0&address=) сложности [добыча биткойнов происходит равномерно](https://blockchain.info/ru/charts/total-bitcoins?timespan=all&showDataPoints=false&daysAverageString=1&show_header=true&scale=0&address=) и в точности как задумал создатель; отметим, что за первые 5.5 лет работы протокола добыто [немногим более 13 миллионов биткойнов](http://coinmarketcap.com/). 

#### Кто может заниматься майнингом?

Кто угодно, если у него есть возможность тратить на это вычислительные ресурсы контролируемых им устройств.

#### Выгодно ли в 2014 году заниматься майнингом?

Скорее нет, чем да. [В этом подразделе](https://github.com/snordenstorm/wiki/wiki/%D0%9C%D0%B0%D0%B9%D0%BD%D0%B8%D0%BD%D0%B3-%D0%B1%D0%B8%D1%82%D0%BA%D0%BE%D0%B9%D0%BD%D0%BE%D0%B2#%D0%9C%D0%BE%D0%B6%D0%BD%D0%BE-%D0%BB%D0%B8-%D0%B7%D0%B0%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D1%82%D1%8C-%D0%BC%D0%B0%D0%B9%D0%BD%D0%B8%D0%BD%D0%B3%D0%BE%D0%BC) данной статьи мы пытаемся исследовать это подробно.

#### Хорошо, а что происходит при майнинге технически? В чём заключается сам процесс?

![by hand](https://pbs.twimg.com/media/BypRWkOIUAAceP9.png)

<blockquote class="twitter-tweet" lang="ru"><p>Попытка майнить биткойн вручную: выходит пара хэшей в час. Как-то непрактично получается. <a href="https://twitter.com/kenshirriff">@kenshirriff</a> <a href="http://t.co/K8qOO0GE8L">pic.twitter.com/K8qOO0GE8L</a></p></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

##### Что есть майнинг: в нулевом приближении

Майнинг это ______________, и если кому-то удастся ____________, то он молодец и получает 25 BTC.

##### Что есть майнинг: на самом деле

Процесс майнинга заключается в том, что майнер пытается подобрать такое число `nonce` (nonce — не имеющее никакого глубокого смысла число, сокращение от "number used once"), что хэш-функция `sha256(sha256(Block_Header))` даёт число, меньшее так называемого [target](https://en.bitcoin.it/wiki/Target) — некоторого крайне малого динамически изменяющегося 256-битного числа. Иногда условие `sha256(sha256(Block_Header)) < target` также звучит как "подходящий хэш должен начинаться с некоторого числа нулей". Что такое хэш-функция sha256(), [знает википедия](https://ru.wikipedia.org/wiki/SHA-2). Что такое этот самый Block_Header? По-русски это называется "заголовок блока" :), и состоит он из 80 байт, а именно, 

  | Что это | Когда изменяется | Размер в байтах
------------ | ------------- | ------------- | -------------
Версия | Текущая версия протокола | В случае изменения протокола | 4
Хэш предыдущего блока | 256-битный хэш предыдущего заголовка блока | При переходе к майнингу следующего блока | 32
Корневой хэш дерева Мёркла | 256-битный хэш, основанный на всех транзакциях, включаемых в искомый блок | Когда майнер принимает транзакцию | 32
Таймштамп | Текущее [Unix-time](https://ru.wikipedia.org/wiki/UNIX-%D0%B2%D1%80%D0%B5%D0%BC%D1%8F) в секундах | Каждые несколько секунд | 4
Bits | Текущее значение target в компактном формате | После каждого изменения [сложности](https://en.bitcoin.it/wiki/Difficulty) | 4
Nonce | 32-битное число (начинающееся с 0) | После каждой неудачной попытки происходит nonce++ | 4

Заголовок блока является результатом [конкатенации](http://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BD%D0%BA%D0%B0%D1%82%D0%B5%D0%BD%D0%B0%D1%86%D0%B8%D1%8F) этих шести параметров. (Более точно, два из них при этом записываются в обратном порядке: `concatenate (версия; хэш предыдущего блока, записанный в обратном порядке; корневой хэш дерева Мёркла, записанный в обратном порядке; таймштамп; bits; nonce)`. Ещё одно несущественное уточнение: не sha256(sha256(Block_Header)) должно быть меньше target, а записанное в обратном порядке sha256(sha256(Block_Header)).) Чуть более подробно об этом написано [здесь](https://en.bitcoin.it/wiki/Block_hashing_algorithm).

Соответственно, если кому-то повезло, то он предъявляет все данные, от которых брал хэш, и говорит: "смотрите! у меня получилось!". Другие майнеры независимо друг от друга вычисляют один этот хэш и говорят: "да, чувак", добавляют блок в блокчейн и отправляются майнить следующий. (Или не добавляют, если им что-то не нравится — каждый сам принимает решение, а несвязанность майнеров друг с другом является залогом его объективности.) Майнер-победитель подписывает своим хэшем этот блок и получает награду за подписание блока (которая сейчас составляет 25 BTC (~10 000$)) + комиссии всех транзакций в этом блоке. Таким образом, борьба идёт за то, чтобы найти подходящий хэш, чтобы сразу после этого подписать им блок, потому что это означает, что 25 BTC награды становятся твоими. [(Наглядная иллюстрация к сказанному.)](https://en.bitcoin.it/wiki/Proof_of_work#Example)

На данный момент неизвестен способ находить такие `nonce` как-либо ещё, кроме как перебором. SHA256-хэширование используется в банковской сфере в течение десятилетий и способ восстановления прообраза по хэшу до сих пор не был обнаружен. Что также приятно, потенциальный взлом SHA256-хеширования не оставляет возможностей для скрытной манипуляции: сообщество заметит, что `nonce` генерируются очень легко и быстро, в результате чего просто перейдёт на другой алгоритм хеширования.

Итак, ещё раз: всё, чем занимаются майнеры — пытаются найти такие содержащиеся в Block_Header данные (в частности, перебирают nonce), что sha256(sha256(Block_Header)) < target. Чем больше хэшей вы переберёте, тем выше ваши шансы подобрать подходящий хэш. Очевидно также, что чем меньшим числом является target, тем труднее подобрать такой хэш. Таким образом, майнинг может показаться лотерей, шансы выигрыша в которой пропорциональны затрачиваемым вычислительным мощностям. Однако настоящий смысл представленной конструкции под названием "майнинг" в том, что без чего-то подобного невозможна устойчивая к атакам система децентрализованной обработки транзакций, и [в следующем разделе](https://github.com/snordenstorm/wiki/wiki/%D0%9C%D0%B0%D0%B9%D0%BD%D0%B8%D0%BD%D0%B3-%D0%B1%D0%B8%D1%82%D0%BA%D0%BE%D0%B9%D0%BD%D0%BE%D0%B2#%D0%97%D0%B0%D1%87%D0%B5%D0%BC-%D0%BD%D1%83%D0%B6%D0%B5%D0%BD-%D0%BC%D0%B0%D0%B9%D0%BD%D0%B8%D0%BD%D0%B3) будет рассказано, почему эта конструкция должна быть именно такой (почему она не может быть проще).

##### Как связаны target и сложность

[Сложность](https://en.bitcoin.it/wiki/Difficulty) майнинга и [target](https://en.bitcoin.it/wiki/Target) связаны следующей формулой:

```current_difficulty = difficulty_1_target / current_target```.

*(В какую сторону округляется результат деления?)*

Понятно, что чем меньше target, тем больше сложность, and vice versa. Кроме того, это видно из условия  `sha256(sha256(Block_Header)) < target`, если включить здравый смысл.

##### Как пересчитывается сложность

Согласно протоколу Биткойн, сложность автоматически подстраивается так, чтобы, как бы ни изменялась вычислительная мощность майнеров, среднее время нахождения блока было равно 10 минутам. Пересчёт этот происходит каждые 2016 блоков. Заметим здесь, что 10 минут ⋅ 2016 = 2 недели. Если последние 2016 блоков были найдены быстрее, чем за 2 недели, протокол воспринимает это как сигнал того, что мощность участвующих в майнинге устройств увеличилась, и сложность растёт. Если соответствующие 2016 блоков были найдены медленнее, чем за 2 недели, сложность падает. Новое значение сложности можно вычислить из пропорции:

last difficulty — actual time of finding the corresponding 2016 blocks

new difficulty — 2 weeks

После пересчёта сложности, естественно, тут же пересчитывается target, так как именно он входит в неравенство, определяющее "успешность" хэша. Сложность, как уже было сказано, вычисляется из

current_difficulty = difficulty_1_target/current_target = 2<sup>224</sup>/current_target, откуда

target = 2<sup>224</sup>/difficulty.

Так и вычисляется новое значение target. (С одной оговоркой: во избежание резких скачков сложности target никогда не изменяется более чем в 4 раза.) Осталось переписать target в компактной форме ("bits"). 

##### Учимся переходить между компактной формой записи target и обычной

(Заранее отметим, что запись, начинающаяся на 0x, есть лишь способ обозначения 16-ричного числа: например, "0xff = шестнадцатиричное число ff".) Target является 256-битным числом, что эквивалентно шестнадцатиричной записи 64-мя символами или записи 32 байтами. Однако в блоке target хранится как-то не так: именно, в виде `0x1b0404cb`. Это выглядит как шестнадцатиричное число, но, кажется, оно какое-то слишком короткое. На самом деле только кажется: по такому числу вполне можно восстановить его полную 64-символьную шестнадцатиричную (и, как следствие, затем при необходимости 256-битную).

Именно, пусть мы хотим перейти из компактной записи `target = 0x1b0404cb` в нормальную. Делается это так:

0x0404cb ⋅ 2<sup>8 ⋅ (0x1b - 3)</sup> = (0x4 ⋅ 16<sup>4</sup> + 0x4 ⋅ 16<sup>2</sup> + 0xc ⋅ 16<sup>1</sup> + 0xb ⋅ 16<sup>0</sup>) ⋅ 2<sup>8 ⋅ (27-3)</sup> = (0x4 ⋅ 16<sup>4</sup> + 0x4 ⋅ 16<sup>2</sup> + 0xc ⋅ 16<sup>1</sup> + 0xb ⋅ 16<sup>0</sup>) ⋅ 16<sup>48</sup> = 0x4 ⋅ 16<sup>52</sup> + 0x4 ⋅ 16<sup>50</sup> + 0xc ⋅ 16<sup>49</sup> + 0xb ⋅ 16<sup>48</sup> = 0x00000000000404cb000000000000000000000000000000000000000000000000

Сатоши (создатель Bitcoin) решил, что минимальная сложность будет называться сложностью 1, а target, который ей будет соответствовать, в компактной форме будет выглядеть как [0x1d00ffff](http://blockexplorer.com/b/0). Вычислим соответствующее ему полную форму записи target: 

0x00ffff ⋅ 2<sup>8 ⋅ (0x1d - 3)</sup> = (0xf ⋅ 16<sup>3</sup> + 0xf ⋅ 16<sup>2</sup> + 0xf ⋅ 16<sup>1</sup> + 0xf ⋅ 16<sup>0</sup>) ⋅ 2<sup>8 ⋅ (29-3)</sup> = (0xf ⋅ 16<sup>3</sup> + 0xf ⋅ 16<sup>2</sup> + 0xf ⋅ 16<sup>1</sup> + 0xf ⋅ 16<sup>0</sup>) ⋅ 16<sup>52</sup> = 0xf ⋅ 16<sup>55</sup> + 0xf ⋅ 16<sup>54</sup> + 0xf ⋅ 16<sup>53</sup> + 0xf ⋅ 16<sup>52</sup> = 0x00000000ffff0000000000000000000000000000000000000000000000000000

Более высокие значения target не разрешены. Итак, мы понимаем, как перейти от компактной формы записи target к полной. 

Однако понимаем ли мы обратный переход? Понимаем, если свыше на нас свалится знание о том, что множитель, умножающийся на два в какой-то степени, может принимать значения только внутри некоторого интервала. Именно, максимальное значение, которое он может принимать — `0x7fffff`; минимальное — `0x008000`. Зачем так сделано? Чтобы не было многозначности при обратном переходе: дело в том, что переход от, скажем, 2<sup>8 ⋅ (0x1b - 3)</sup> к 2<sup>8 ⋅ (0x1c - 3)</sup> (увеличение переменной в показателе степени на единицу) эквивалентен умножению на 16<sup>2</sup>, т.е. приписыванию двух нулей справа в шестнадцатиричной нотации. Поэтому ограничение на preceeding множитель приводит к непрерывности биекции: если число 0x7fffff можно записать как 0x7fffff ⋅ 2<sup>8 ⋅ (0x3 - 3)</sup>, то число 0x800000 предлагается записывать в виде 0x008000 ⋅ 2<sup>8 ⋅ (0x4 - 3)</sup> на пути к компактной форме.

##### Максимально и минимально возможные значения сложности и target

Поговорим, кстати, про максимально и минимально возможные значения. Максимально возможное значение target вот ровно это, соответствующее сложности 1. Минимально возможное — то, при котором target как 256-битное число равен 1 (т.е. существует всего один хэш, решающий задачу `sha256(sha256(Block_Header)) < target`, и этот хэш — ноль). Вычисляя по формуле сложность как difficulty = difficulty_1_target / 1 = difficulty_1_target = 15 ⋅ 16<sup>55</sup> + 15 ⋅ 16<sup>54</sup> + 15 ⋅ 16<sup>53</sup> + 15 ⋅ 16<sup>52</sup>, получим очень большое число (примерно равное 2<sup>224</sup>). К счастью, сложность таковой никогда не будет, надо надеяться. Минимальное возможное значение target даёт максимально возможное значение сложности и наоборот, очевидно.

##### Формула, связывающая hashrate, estimated time of success и difficulty

Назовём успехом ситуацию, при которой подходящий хэш найден (после чего майнер подписывает им блок с транзакциями, а сеть соглашается с ним и переходит к поиску хэша, которым можно было бы подписать уже следующий блок).

Чему равно матожидание количества хэшей, которые придётся вычислить для одного успеха? Пусть для каждой из попыток вероятность успеха — p, вероятность неудачи — q. Один успех может произойти с первой попытки, и вероятность этого p; может произойти со второй, и вероятность этого pq, с третьей pq<sup>2</sup>; ... . Пользуясь [определением](http://ru.wikipedia.org/wiki/%D0%9C%D0%B0%D1%82%D0%B5%D0%BC%D0%B0%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5_%D0%BE%D0%B6%D0%B8%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5#.D0.9C.D0.B0.D1.82.D0.B5.D0.BC.D0.B0.D1.82.D0.B8.D1.87.D0.B5.D1.81.D0.BA.D0.BE.D0.B5_.D0.BE.D0.B6.D0.B8.D0.B4.D0.B0.D0.BD.D0.B8.D0.B5_.D0.B4.D0.B8.D1.81.D0.BA.D1.80.D0.B5.D1.82.D0.BD.D0.BE.D0.B3.D0.BE_.D1.80.D0.B0.D1.81.D0.BF.D1.80.D0.B5.D0.B4.D0.B5.D0.BB.D0.B5.D0.BD.D0.B8.D1.8F) матожидания дискретно распределённой величины,

1 ⋅ p + 2 ⋅ pq + 3 ⋅ pq<sup>2</sup> + ... = p (1 + 2q + 3q<sup>2</sup> + ...) = p (1 + q + q<sup>2</sup> + q<sup>3</sup> + ...)'<sub>q</sub> = p (1/(1-q))'<sub>q</sub> = p (1/(1-q)<sup>2</sup>) = p (1/p<sup>2</sup>) = 1/p.

Великолепно! Вероятность нашего успеха в точности равна отношению количества подходящих хэшей ко всем возможным:

p = target/2<sup>256</sup> => 1/p = 2<sup>256</sup>/target = 2<sup>256</sup>/(2<sup>224</sup>/difficulty) = 2<sup>32</sup> ⋅ difficulty

таким образом,

estimated number of hashes to succeed = 2<sup>32</sup> ⋅ difficulty =>

hashrate ⋅ estimated time of success = 2<sup>32</sup> ⋅ difficulty

откуда можно вычислить любую из этих трёх величин, зная две другие. Difficulty — величина глобальная; hashrate и time — локальные, т.е. могут применяться к отдельно взятому майнеру (а могут, впрочем, и ко всей сети). С помощью этой формулы можно, например, радостно посчитать, что при текущей сложности на генерацию одного блока у моего ноутбука с хэшрэйтом 2 Mhash/s ушло бы (в среднем) два с половиной миллиона лет.

##### Графики и литература

[График изменения сложности.](https://blockchain.info/ru/charts/difficulty?timespan=all&showDataPoints=false&daysAverageString=1&show_header=true&scale=0&address=) Actual values: [current target](http://blockexplorer.com/q/hextarget), [current difficulty](http://blockexplorer.com/q/getdifficulty). 

(Слово target мной не переводится, поскольку "цель" можно легко спутать со словом "цепь", также встречающимся в контексте Биткойн.)

*(Есть один непонятный для меня момент. Nonce — 32-битное число, так что перебор всех nonce для заданного таймштампа и заданного набора транзакций осуществляется за 2<sup>32</sup> вычислений. Это примерно равно 4.3 ⋅ 10<sup>9</sup> хэшей, 4.3 гигахэша. Современные майнеры выдают 3 терахэша в секунду. Что они перебирают в ту оставшуюся часть секунды, после того как перебрали первые 4.3 гигахэша? Таймштамп-то в течение секунды не изменяется. А новых транзакций может поступить не больше 7 в секунду (сейчас таков предел для сети Биткойн).)*

*(Говорят, что эта проблема решается с помощью extranonce.)*

#### Зачем нужен майнинг?

Дочитав до технического описания майнинга, читатель может воскликнуть: ну зачем так, неужели нельзя проще? Здесь как с PGP — проще нельзя; если что-то выкинуть, безопасность сломается. В некотором смысле конструкция майнинга биткойнов — это примитив, от которого можно отталкиваться, предлагая свои способы достижения децентрализованного соглашения.

Биткойн является первой децентрализованной цифровой валютой. Не первой цифровой валютой вообще, но первой децентрализованной цифровой валютой. Каким образом этот прорыв был совершён, и где терпели неудачу те, кто пытались совершить его раньше?

Используя хорошо известные в криптографии понятия публичного и приватного ключа, можно доказывать с помощью цифровых подписей владение тем или иным активом, а также своё желание передать его кому-то другому (владельцу другого публичного ключа). Ключевой проблемой здесь является проблема двойной траты: не существует криптографического способа узнать, не были ли передаваемые активы переданы перед этим кому-нибудь ещё.

Централизованные цифровые валюты просто хранили у себя на серверах лог всех транзакций, тем самым решая проблему. Однако функционировать централизованная цифровая валюта может лишь до тех пор, пока по адресу расположения используемых серверов не пришли дяди из ФБР или других компетентных органов. Ровно это произошло с валютой [Liberty Reserve](http://en.wikipedia.org/wiki/Liberty_Reserve). Любая централизация создаёт точку уязвимости и потому не годится.

Решение проблемы двойной траты, используемое в Биткойн — хранить лог транзакций распределённым образом, причём с помощью энтузиастов: каждый может скачать "публичную книгу учёта" всех транзакций, которая будет непрерывно синхронизироваться с остальными такими книгами. Казалось бы, такое решение лежит на поверхности; в чём же здесь прорыв? Дело в том, что это не решение — точнее, это "решение" приводит к ещё большему количеству вопросов. Именно, как сделать так, чтобы история транзакций у всех пользователей была одинаковая? При том, что каждому (или почти каждому), безусловно, хотелось бы сделать так, чтобы его исходящие транзакции не попали в конечном счёте в "книгу учёта" после получения им товара. Без решения этой проблемы Биткойн никому не был бы интересен, потому что представлял бы собой конкурирующие друг с другом "книги учёта" с мошеннически выборочно включаемыми транзакциями, выгодными тем или иным участникам.

Сразу на ум приходит решение вида "дать возможность голосовать за правильную книгу учёта", однако оно тоже оказывается неподходящим — купить ботнет или симулировать любое необходимое количество IP-адресов не так сложно. Кроме того, даже если каким-то образом удастся гарантировать принцип "1 человек — 1 голос", это не решает проблему экономических стимулов: для каждого пользователя экономическим стимулом всё равно останется голосовать за ту версию истории транзакций, которая ему наиболее выгодна.

Концепция майнинга как раз и решает проблему экономического стимулирования пользователей хранить правильную и единую историю транзакций. Именно это глубоко нетривиально.


Кроме того, у читателя может возникнуть ложное представление о том, что майнинг нужен для раздачи монет (и именно в этом контексте обычно знакомство с майнингом и начинается). Это правда, но это совершенно вторично.

Это выбранный создателем способ обеспечения инфраструктуры и безопасности Биткойн-транзакций. В традиционных платёжных системах (Visa, Mastercard, Paypal) транзакции проходят через централизованного посредника, который списывает с тебя годовую плату за обслуживание, и, что главное, которому тебе приходится доверять. Смысл же криптовалют — исключить необходимость кому-либо доверять.

Майнинг предназначен не для создания новых единиц (кому бы они были нужны сами по себе?), а для подтверждения транзакций. Биткойны имеют ценность только благодаря надежной платежной сети, которая поддерживается майнерами. А майнеры получают оплату за свою работу в виде комиссионных за транзакции и создаваемых биткойнов.

В условиях, когда каждый как бы сам себе банк, участники должны иметь возможности договариваться о том, кто кому сколько переслал. Для децентрализованности информация о транзакциях должна храниться распределённо. Отсюда следует необходимость блокчейна: публичной бухгалтерской книги, которую может загрузить на жёсткий диск каждый энтузиаст.
Блок включает в себя все недавние транзакции (транзакции, которые не вошли ни в один из предыдущих блоков).

Если среди таких энтузиастов найдётся злоумышленник, который подменит одну транзакцию на другую в каком-то из блоков, то за счёт того, что блоки в блокчейне хранятся в виде [деревьев Мёркла](https://github.com/snordenstorm/wiki/wiki/%5BRussian%5D-White-Paper#%D0%94%D0%B5%D1%80%D0%B5%D0%B2%D1%8C%D1%8F-%D0%9C%D1%91%D1%80%D0%BA%D0%BB%D0%B0), у такого блока изменится root hash, и proof-of-work его также будет невалиден. Чтобы остальная сеть согласилась с существованием такого блока, нашему злоумышленнику придётся заново проделать proof-of-work для такого чуть изменённого блока *(при этом сложность будет равна чему?)*. Далее, поскольку истинной считается та цепочка блокчейна, у которой суммарная сложность наибольшая, нашему злоумышленнику придётся догнать и перегнать блокчейн "честных" майнеров. Это возможно, только если вычислительная мощность злоумышленника составляет более 50% вычислительной мощности всей сети. Это называется "атакой 51%"; [в последнем разделе](https://github.com/snordenstorm/wiki/wiki/%D0%9C%D0%B0%D0%B9%D0%BD%D0%B8%D0%BD%D0%B3-%D0%B1%D0%B8%D1%82%D0%BA%D0%BE%D0%B9%D0%BD%D0%BE%D0%B2#%D0%92%D1%81%D1%91-%D0%BF%D1%80%D0%BE-%D0%B0%D1%82%D0%B0%D0%BA%D1%83-51) этой статьи даётся грубая оценка стоимости этой атаки (на сегодняшний день она обойдётся в 250 миллионов долларов).

(Да, вопреки распространённому мнению, истинной действительно является не самая длинная цепочка, а цепочка с наибольшей суммарной сложностью — это защищает от атак вида "сделать форк и, добившись малой сложности, подписать много блоков".)

Транзакции запаковываются в блоки и в процессе майнинга эти блоки запечатываются. Блоки образуют цепочку блоков (блокчейн). Блокчейн хранит все когда-либо произошедшие биткойн-транзакции ("если какая-то транзакция не находится в блокчейне, её не происходило") и хранится на компьютере любого энтузиаста, и каждый из этих компьютеров самостоятельно проверяет валидность новых блоков. Энтузиастов таких сейчас примерно 7000, их компьютеры разбросаны по всему миру. Ты можешь стать таким энтузиастом.

Чтобы у людей был какой-то стимул заниматься майнингом (запаковывать транзакции в блоки), майнеру за каждый новый подписанный подходящим хэшем блок выплачивается награда, на данный момент составляющая 25 BTC (~10 000$ по курсу на ноябрь 2014). Это же и способ эмиссии (выпуска) новых биткойнов, причём единственный способ эмиссии. Также майнер забирает себе все комиссии всех транзакций, вошедших в добытый блок, если авторы этих транзакций установили комиссии, отличные от нуля.

Единственным способом создания новых блоков и записи транзакций является майнинг, и майнеры являются фундаментом сети, который поддерживает её работоспособность; взамен майнеры получают вознаграждение в виде добытых монет.

[(Количество подписанных блоков на данный момент.)](http://blockexplorer.com/q/getblockcount)

Поскольку каждый из блоков ссылается на предыдущий (содержит хэш предыдущего), можно сказать, что блоки упорядочены и образуют цепочку: *blockchain*, **блокчейн**. Однако эта цепь может расщепляться и без злоумышленников — это произойдёт тогда, когда два майнера почти одновременно найдут и транслируют в сеть сообщение о том, что они нашли подходящий хэш (и хэши будут разными). Тогда вполне может случиться такое, что какая-то часть майнеров начнёт работать над подписанием следующего блока на цепочке первого, а какая-то — на цепочке второго. Однако же очень быстро станет понятно, на какой из цепочек вычислительных мощностей больше, и, поскольку за подписание блоков на цепочке с не самой большой суммарной сложностью (=не на самой мощной) никаких выплат нет, все перебегут на цепочку с самой большой вычислительной мощностью. Таким образом, расщепление возможно, но довольно быстро разрешается само собой. Сформированные таким образом записи невозможно изменить, не выполнив заново всего объёма вычислений.

Бывают валюты без майнинга в том понимании, в котором о нём рассказывается в этой статье. Здесь рассказывается про то, как устроен майнинг в случае (первой и пока что главной) валюты — Биткойн (PoW-майнинг, PoW = proof of work). Бывает также [PoS-майнинг](http://habrahabr.ru/post/207120/) (proof of stake), бывают гибридные (PoW/PoS, обычно с коротким временем PoW) валюты. Есть и другие идеи: proof-of-excellence (она же proof-of-play), [proof-of-burn](http://bitcoin.stackexchange.com/questions/24187/what-is-proof-of-burn) (Counterparty), ...

#### Ну хорошо, вот человечество вычисляет примерно 10<sup>17</sup> хэшей в секунду с целью подобрать подходящее значение nonce. Какова польза человечеству от этих вычислений?

Реальная полезность любого вида майнинга — это обеспечение надежного клиринга и невозможности подделок и "откатов транзакций". В нецифровых валютах, эта задача решается (и то не полностью) комплексом дорогостоящих мероприятий по "защите от подделок", постоянной проверкой подлинности банкнот и многоуровневым ограничениям доступа к банковской системе. Даже сама по себе "банковская безопасность" — это многомиллиардная индустрия, где кормится куча компаний. То, что Биткойн позволяет перестать зря транжирить все эти огромные ресурсы, просто заменив их вычислительной мощностью — это огромная экономия и польза для всего человечества.

#### Что такое майнинг-пулы?

Майнинг — процесс вероятностный: те, кому удаётся найти подходящий хэш, получают награду (50 BTC originally); те, кому не удаётся — ничего. Со временем людям играть в эту рулетку надоело (видел на Хабре комментарий человека, который в 2009-м майнил без пула: быстро подписал два блока, а потом майнил девять месяцев вхолостую, пока не подписал третий), тем более что с притоком всё новых майнеров шансы на подписание блока становились всё меньше. Люди стали объединяться в пулы (pools, mining pools). Пул — это "артель старателей", в которой майнеры объединяют свои вычислительные мощности для подписания блока; пул постоянно раздаёт участникам всё новые и новые "шары" (shares, доли, вычислительные мини-задания) и обрабатывает ответы участников; если пулу везёт и кто-то из его участников находит подходящий хэш, вся полученная награда распределяется пропорционально проделанной участниками вычислительной работе, так что свой кусок награды получает каждый. Мелкие пулы, как правило, не берут с участников вообще никакой платы; большинство предлагает рекомендуемый процент за обслуживание, но в настройках аккаунта его обычно можно установить равным нулю. (Ответ на вопрос, на что живут пулы и в чём для них экономический смысл этим заниматься, мне неизвестен. Вполне возможно, мухлюют.) Прежний способ майнинга стали называть соло-майнингом. Таким образом, пул делает доход майнера плавным, и в этом его предназначение.

В данный момент 100% вычислительных мощностей сети контролируются майнинг-пулами — веб-серверами, раздающими майнерам вычисления по перебору хэшей (шары, shares), получающими от них ответы и распределяющими награду за найденный хэш пропорционально вкладу каждого (количеству перебранных хэшей). Этакая артель старателей, в которой награда пропорциональна количеству фактически выполненной работы, что призвано сгладить вероятностную природу майнинга, сделав доход постоянным и равномерным. Примерно 50% мощностей контролируются крупнейшим пулом [ghash.io](https://ghash.io/), который даже [созывал круглый стол](http://bitnovosti.com/2014/06/20/51-attack-again/), чтобы придумать, как избежать концентрации мощностей майнинга в одних руках (им выгодно не превышать планку 50%, иначе будет падать доверие к сети Биткойн, а, значит, и курс).

Стоит также отметить такое явление, как мультипулы — пулы, которые в фоновом режиме по сложности и курсам валют вычисляют profitability всех валют и после нахождения блока перескакивают на наиболее профитную. Самым известным мультипулом, по-видимому, является [multipool.us](https://www.multipool.us/). Самым крупным пулом вообще — [ghash.io](https://ghash.io/), к которому подключены сейчас 25% всей вычислительной мощности сети Биткойн. (Что забавно, на короткое время хэшрэйт этого пула несколько раз превысил половину хэшрэйта всей сети — подробнее в [этой](http://bitnovosti.com/2014/01/19/bitcoin-mainery-i-centralizaciya/), [этой](http://bitnovosti.com/2014/06/20/51-attack-again/) и [этой](http://coinspot.ru/technology/mining/pul-ghash-io-kontroliroval-51-vsej-vychislitelnoj-moshhnosti-seti/) статье.)

#### Что такое АСИКи?

Из приведённого описания процесса майнинга видно, что чем больше хэшей в секунду перебирает майнер, тем выше вероятность того, что именно он найдёт подходящий хэш и получит награду за подписание блока. Именно с этим и связана гонка вооружений. Hashrate процессора ноутбука, с которого я всё это пишу — 2 Mhash/s; это означает, что мой процессор перебирает примерно 2 миллиона SHA256-хэшей (а именно этот алгоритм хэширования используется в Биткойн) в секунду. Hashrate всей сети Биткойн [на момент написания этой статьи равен 250 Phash/s](http://bitinfocharts.com/ru/) (Phash = 10<sup>15</sup> hash). В теории каждый может майнить на своём ноутбуке, но в 2014 году, когда сложность находится у небес, износ оборудования и электричество обойдутся дороже. Если б я занимался соло-майнингом биткойна на своём ноутбуке, то шанс на то, что в ближайшие 10 минут именно я найду заветный хэш, был бы равен (2 Mhash/s)/(250 Phash/s) = (2 ⋅ 10<sup>6</sup>)/(250 ⋅ 10<sup>15</sup>) = мне лень писать столько нулей после запятой. ([Current probability of winning a block per attempt.](http://blockexplorer.com/q/probability)) 

Люди, впрочем, не идиоты, и соло-майнингом биткойнов занимаются только если контролируют сумасшедшие вычислительные мощности (иначе очень велик шанс заработать 0 BTC за всё время майнинга). Из проведённого вычисления также ясно, что в 2014 году в майнинге без специализированного оборудования, hashrate которого не 2 Mhash/s, а в тысячи раз выше, делать нечего. Есть ощущение, что в майнинге вообще никому, кроме производителей спецоборудования, делать уже нечего — гораздо выгоднее делать приложения, сервисы и инфраструктуру сети Биткойн и иметь с этого деньги, свободно путешествуя по планете Земля. 

Спецоборудование это называется АСИКами (ASICs, application-specific integrated circuits). Эти устройства не умеют ничего, кроме как вычислять SHA256-хэши. За счёт гигантского распараллеливания вычислений достигается выигрыш в производительности в 1000-10000 раз даже по сравнению с самым распространённым на тот момент способом майнинга (майнингом на видеокартах). Именно в момент появления и массовой скупки АСИКов сложность майнинга резко взлетела, и майнинг на видеокартах сразу перестал быть выгоден. Сейчас фермы и промышленные майнинг-центры, состоящие из АСИКов — основной способ майнинга. Две статьи с фоточками биткойн-ферм: [первая](http://bitnovosti.com/2014/09/19/ferma-iznutri-foto/), [вторая](http://bitnovosti.com/2014/07/14/maining-sklady-zavody/). 

Суммарная вычислительная мощность всех Биткойн-майнеров сейчас в 50 раз превышает суммарную вычислительную мощность 500 самых производительных суперкомпьютеров мира. Так было, конечно, не всегда, и начиналось всё с майнинга на обычных процессорах, а граф эпох майнинга сейчас выглядит так: CPU (процессор) → GPU (видеокарта) → FPGA (ПЛИС) → ASIC → ?

#### Можно ли заработать майнингом?

Майнинг похож на создание денег из воздуха, и желание поучаствовать в этом возникает естественным образом. Но надо понимать, что времена 10000%-ных прибылей в майнинге прошли, и в 2014 году майнинг — сложный бизнес, в котором запросто можно остаться в минусе. Безусловно, когда-то можно было при некоторой удаче намайнить себе 100 BTC (50 000$ по курсу на сентябрь 2014-го) за сутки (или купить за копейки — см. [динамику стоимости одного биткойна](https://blockchain.info/ru/charts/market-price?timespan=all&showDataPoints=false&daysAverageString=1&show_header=true&scale=0&address=)), но сейчас не 2009-й и не 2010-й: конкуренция очень высока. Огромное количество спецтехники по всему миру сейчас занято в майнинге, сложность находится [около небес](https://bitinfocharts.com/ru/), и, соответственно, чтобы заниматься майнингом, нужно иметь вычислительные мощности около небес, т.е. вложить несколько десятков или сотен тысяч долларов в оборудование. 

Попробуем набросать бизнес-план: вдруг получится? Планируемый KnC на третий квартал майнер Нептун будет выдавать минимум 3000 GHash/s при стоимости 6000$ за штуку. Хэшрэйт сети на сегодня (назовём этот момент времени t<sub>0</sub>) составляет [240 PHash/s](https://bitinfocharts.com/ru/): H(t<sub>0</sub>) = 240 Phash/s. Предположим, сегодня мы закупаем и сразу запускаем оборудование, которое суммарно выдавало бы 2.4 PHash/s — 1% текущей мощности сети. Для этого мы должны купить 2400/3 = 800 штук майнеров. При стоимости 6000$ за штуку это обойдётся нам в 800 ⋅ 6000$ = 0.8 ⋅ 6 million $ = 4.8 million $. 

Какой ежедневный профит в результате будем мы иметь? Найдём сначала общий доход участников сети в сутки. Сейчас, в 2014, награда за блок составляет 25 BTC (и будет таковой ещё до 2017); среднее время подписания блока же всегда 10 минут. Итого в сутки добывается в среднем 6 ⋅ 24 ⋅ 25 BTC = 3600 BTC. (Сумма всех комиссий в блоке сейчас, как правило, не превышает 0.1 BTC, так что пренебрежём здесь комиссиями для простоты.)

Вероятность подписать блок равна доле контролируемых вычислительных мощностей, поэтому в сутки нашему герою будет доставаться 3600 BTC ⋅ (2.4 Phash/s / H). Перейдём к непрерывному пределу: доход в биткойнах за период времени dt составит db = 3600 BTC ⋅ (2.4 Phash/s / H(t)) (dt / 1 day).
(На самом деле получение BTC и происходит плавно, если майнить в пуле.)

Однако же доход в биткойнах никого не волнует, если ты сначала вложил 4.8 millions $. Такого инвестора, скорее всего, интересует отбить вложения и заработать, по возможности, в долларах. Пусть db — приращение биткойнов, du — приращение долларов США, p(t) — курс, измеряющийся в USD/BTC (например: p = 500 USD/BTC, как сейчас). Тогда p(t) db = du, и du = 3600 BTC ⋅ p(t) ⋅ (2.4 Phash/s / H(t)) (dt / 1 day); окончательно, наш доход в долларах США за период времени T составит

![наш доход в долларах США за период времени T](http://latex.codecogs.com/gif.latex?%5Coperatorname%7Brevenue%7D%20%28T%29%20%3D%203600%20%5Ccdot%20%5Cint%5Climits_%7Bt_0%7D%5E%7Bt_0&plus;T%7D%20p%28t%29%20%5Cfrac%7B2.4%20%5Coperatorname%7BPhash/s%7D%7D%7BH%28t%29%7D%20%5Cfrac%7Bdt%7D%7B1%20%5Coperatorname%7Bday%7D%7D)

Посчитаем этот интеграл в предположении, что подынтегральные функции замерли на своих сегодняшних значениях. Таким образом, положим H(t) = 240 Phash/s, p(t) = 500 USD/BTC. Находя годовой доход, получим

3600 ⋅ 500 ⋅ (1/100) ⋅ 365 $ = 18 ⋅ 0.365 million $ = 6.57 million $. 

Пока что выглядит как полный успех, если вспомнить, что потратили на закупку оборудования мы 4.8 millions $. Выглядит так, как будто мы отбили вложения и неплохо заработали уже за первый год. Однако беглый взгляд на [график изменения полного хэшрэйта сети](https://blockchain.info/ru/charts/hash-rate?timespan=1year&daysAverageString=1&scale=0&address=) за последний год не оставляет надежды: за год он вырос приблизительно в 100 раз. Если хэшрэйт(=H(t)) будет расти такими темпами и дальше, наш предприниматель гарантированно прогорит.

Всё это, разумеется, смягчается тем фактом, что выходят всё новые, всё более мощные поколения майнеров [(закон Мура?)](https://ru.wikipedia.org/wiki/%D0%97%D0%B0%D0%BA%D0%BE%D0%BD_%D0%9C%D1%83%D1%80%D0%B0), однако общая тенденция неутешительная. Есть ощущение, что на майнинге навариваются практически только производители АСИКов.

Мы опустили в этом анализе тот факт, что p(t) — величина не вполне независимая, величина, на которую можно влиять. Курс биткойна задаётся, по сути, игроками с большой денежной массой, крупными воротилами. Но, чтобы его поднять, необходимо продавать доллары за биткойны, а в разбираемом случае у предпринимателя задача скорее обратная — отбить долларовые вложения, заработать доллары. [Высказывалось даже мнение](http://bitnovosti.com/2014/08/29/citi-miners-merchants-keeping-bitcoin-prices-check/), что от неизбежного туземуна нас всех удерживают майнеры, которым необходимо ежедневно продавать добываемые биткойны.

Отобьются ли вложенные деньги? Капитан Очевидность, глядя на приведённую выше красивую формулу, поясняет: ответ на этот вопрос зависит, в первую очередь, от того, как будет изменяться полная вычислительная мощность сети, а также от курса BTC/USD. Имея в виду также закон Мура и тот факт, что постоянно выходят всё новые и всё более мощные устройства для майнинга, устремляющие полный хэшрэйт дальше в небеса, кажется, что закупаться АСИКами и отправляться в кругосветное плавание на год — плохая идея. По крайней мере, чтобы оставаться в гонке, последние мощные модели надо постоянно докупать (и то перспективы неясные).

Этот расчёт довольно приблизителен в том числе потому, что в нём не учтены ощутимые расходы на покупку блоков питания и соответствующей инфраструктуры.

#### Что произойдёт, когда награды за блок станут малы?

Согласно протоколу Биткойн, награда за подписание блока [каждые 4 года будет уменьшаться в 2 раза](https://en.bitcoin.it/wiki/Controlled_supply#Projected_Bitcoins_Long_Term). Одно такое "уполовинивание" мы уже пережили — в 2013 году эта награда уменьшилась с 50 BTC до 25 BTC. В 2017 нас ждёт следующее "уполовинивание" до 12.5 BTC. Уже в 2025 награда составит немногим более 3 BTC, что не выглядит сейчас слишком мотивирующе. (Многое, разумеется, зависит от курса биткойна — если мировое сообщество действительно перейдёт на биткойн и стоимость одного биткойна окажется в районе современных 100000$, как об этом многие грезят, 3 BTC не покажутся маленькой наградой.)

Доход майнера, которому удалось подписать блок, как известно, складывается из награды за подписание блока (сейчас 25 BTC) и суммы всех комиссий в этом блоке. Сейчас исчезающе малую долю этого дохода составляют комиссии; принято считать, что когда награды за нахождение блока станут пренебрежимо малыми, как раз комиссии будут основным доходом майнеров и основным стимулом для людей заниматься майнингом, и определяться размер рекомендуемой комиссии будет свободным рынком, где майнеры продают, а все пользователи — покупают услугу обработки транзакций. На данный момент размер рекомендуемой комиссии составляет 0.0001 BTC (1.5 рубля), и во многих случаях и она необязательна — комиссии на данный момент составляют пренебрежимо малую долю в доходе майнеров. [(Подробнее о комиссиях.)](https://en.bitcoin.it/wiki/Transaction_fees)

Однако почему именно комиссии? Не упадёт ли вместо этого сложность с околонебесной (как сейчас) до обозримой? Где будет точка равновесия — с большими комиссиями и околонебесной сложностью? Или малой сложностью и малыми комиссиями? И каково это — малая сложность — в контексте того, что "атаку 51%" станет произвести значительно дешевле?

Что это будет за фазовый переход?

Пойдём "от предпринимателя" в исследовании данной задачи. Именно, выведем условие, при котором ему выгодно докупить ещё специализированных устройств для майнинга. Давайте работать в предположении, что оборудование можно докупить непрерывно, стоит оно всегда 6000$. Мощность оборудования пусть удовлетворяет закону Мура: растёт в 2 раза каждые 2 года. В качестве начального условия возьмём современный майнер Нептун от KnC, который выдаёт 3 Thash/s и стоит 6000$ за штуку. Из закона Мура

power(t) = power(t<sub>0</sub>) ⋅ 2<sup>0.5 ⋅ (t - t<sub>0</sub>)</sup>.

Какой ежедневный профит такой майнер будет приносить? Найдём сначала общий доход участников сети в сутки. Сейчас, в 2014, награда за блок составляет 25 BTC (и будет таковой ещё до 2017); среднее время подписания блока же всегда 10 минут. Итого в сутки добывается в среднем 6 ⋅ 24 ⋅ 25 BTC = 3600 BTC. 

Вероятность подписать блок равна доле контролируемых вычислительных мощностей, поэтому в сутки докупленное устройство будет добывать 3600 BTC ⋅ (3 Thash/s ⋅ 2<sup>0.5 ⋅ (t - t<sub>0</sub>)</sup> / H). Перейдём к непрерывному пределу: доход в биткойнах за период времени dt составит db = 3600 BTC ⋅ (3 Thash/s ⋅ 2<sup>0.5 ⋅ (t - t<sub>0</sub>)</sup> / H(t)) (dt / 1 day).
(На самом деле получение BTC и происходит плавно, если майнить в пуле.)

Так что доход за сутки без учёта комиссий составит 

![BTC-доход в сутки без учёта комиссий](http://latex.codecogs.com/gif.latex?db%20%3D%203600%20%5Coperatorname%7BBTC%7D%20%5Ccdot%20%5Cfrac%7B3%20%5Coperatorname%7BThash/s%7D%20%5Ccdot%202%5E%7B0.5%20%28t_%7B%5Ctext%7Bbuy%7D%7D%20-%20t_0%29%7D%7D%7BH%28t%29%7D%20%5Cfrac%7Bdt%7D%7B1%20%5Coperatorname%7Bday%7D%7D)

Теперь неплохо бы учесть комиссии, раз мы исследуем равновесие системы, в которой есть понятия награды за подписание блока, определяемой рынком комиссии, и сложности майнинга. Вероятность подписать блок оттого, что мы "включили" в нашем исследовании комиссии, естественно, не поменяется, изменится лишь "сумма выигрыша". Именно, вместо 3600 BTC в вычислениях выше необходимо написать (3600 + (суточный доход всех майнеров от комиссий)) BTC. Чему равен суточный доход всех майнеров от комиссий? За сутки будет подписано 6 ⋅ 24 = 144 блока; пусть рыночное значение комиссии в момент времени t есть fee(t), количество транзакций в блоке — T(t). Тогда доход с одного блока есть fee(t) ⋅ T(t), доход за сутки составит 144 ⋅ fee(t) ⋅ T(t). Таким образом, доход всех майнеров за сутки с учётом комиссий равен не 3600 BTC, а 3600 BTC + 144 ⋅ fee(t) ⋅ T(t) (на самом деле, 144 ⋅ (25 + fee(t) ⋅ T(t)) BTC, 25 — та самая текущая награда за блок).

Отметим это в виде красивой формулы. BTC-доход с учётом комиссий:

![BTC-доход в сутки с учётом комиссий](http://latex.codecogs.com/gif.latex?db%20%3D%20%283600%20&plus;%20144%20%5Coperatorname%7Bfee%7D%28t%29%20T%28t%29%29%20%5Coperatorname%7BBTC%7D%20%5Ccdot%20%5Cfrac%7B3%20%5Coperatorname%7BThash/s%7D%20%5Ccdot%202%5E%7B0.5%20%28t_%7B%5Ctext%7Bbuy%7D%7D%20-%20t_0%29%7D%7D%7BH%28t%29%7D%20%5Cfrac%7Bdt%7D%7B1%20%5Coperatorname%7Bday%7D%7D)

Пусть db — приращение биткойнов, du — приращение долларов США, p(t) — курс, измеряющийся в USD/BTC (например: p = 500 USD/BTC, как сейчас). Тогда p(t) db = du. USD-доход с учётом комиссий:

![USD-доход в сутки с учётом комиссий](http://latex.codecogs.com/gif.latex?du%20%3D%20%283600%20&plus;%20144%20%5Coperatorname%7Bfee%7D%28t%29%20T%28t%29%29%20%5Ccdot%20p%28t%29%20%5Ccdot%20%5Cfrac%7B3%20%5Coperatorname%7BThash/s%7D%20%5Ccdot%202%5E%7B0.5%20%28t_%7B%5Ctext%7Bbuy%7D%7D%20-%20t_0%29%7D%7D%7BH%28t%29%7D%20%5Cfrac%7Bdt%7D%7B1%20%5Coperatorname%7Bday%7D%7D)

Когда выгодно докупать оборудование? Когда его стоимость отобьётся, т.е. доход, полученный от устройства, превысит 6000$. Как посчитать полный доход от купленного устройства? Если пренебречь расходами на электричество и износом оборудования, ничто не мешает устройству работать вечно; полный доход составит 

![USD-условие](http://latex.codecogs.com/gif.latex?%5Cint%5Climits%5E%7B%5Cinfty%7D_%7Bt_%7B%5Ctext%7Bbuy%7D%7D%7D%20%283600%20&plus;%20144%20%5Coperatorname%7Bfee%7D%28t%29%20T%28t%29%29%20%5Ccdot%20p%28t%29%20%5Ccdot%20%5Cfrac%7B3%20%5Coperatorname%7BThash/s%7D%20%5Ccdot%202%5E%7B0.5%20%28t_%7B%5Ctext%7Bbuy%7D%7D%20-%20t_0%29%7D%7D%7BH%28t%29%7D%20%5Cfrac%7Bdt%7D%7B1%20%5Coperatorname%7Bday%7D%7D%20%3E%206000)

Эта формула замечательна и красива ровно до 2017 года, когда вместо 3600 придётся написать 1800, что на самом деле поменяет ситуацию довольно драматически. Мы же как раз это и планировали описывать: эффекты, связанные с падением в два раза. Учитывая и их, получим окончательное условие, при котором докупать майнер выгодно:

![Условие с учётом уполовинивания награды](http://latex.codecogs.com/gif.latex?%5Cint%5Climits_%7Bt_%7B%5Ctext%7Bbuy%7D%7D%7D%5E%7B%5Cinfty%7D%20144%20%5CBig%2850%20%5Ccdot%20%5Ctheta%28t-2009%29%20%5Ctheta%282013-t%29%20&plus;%2025%20%5Ccdot%20%5Ctheta%28t-2013%29%20%5Ctheta%282017-t%29%20&plus;%2012.5%20%5Ccdot%20%5Ctheta%28t-2017%29%20%5Ctheta%282021-t%29%20&plus;%20...%20&plus;%20%5Coperatorname%7Bfee%7D%28t%29%20T%28t%29%20%5CBig%29%20%5Ccdot%20p%28t%29%20%5Ccdot%20%5Cfrac%7B3%20%5Coperatorname%7BThash/s%7D%20%5Ccdot%202%5E%7B0.5%20%28t_%7B%5Ctext%7Bbuy%7D%7D%20-%20t_0%29%7D%7D%7BH%28t%29%7D%20%5Ccdot%20%5Cfrac%7Bdt%7D%7B1%20%5Coperatorname%7Bday%7D%7D%20%3E%206000%2C)

где θ(x) — [тета-функция Хевисайда](http://ru.wikipedia.org/wiki/%D0%A4%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D1%8F_%D0%A5%D0%B5%D0%B2%D0%B8%D1%81%D0%B0%D0%B9%D0%B4%D0%B0) ("ступенька"), t<sub>buy</sub> — время покупки майнера, выгодность покупки которого исследуется. Словом, это просто способ записывать кусочно-заданную функцию: выражение θ(t-2009) ⋅ θ(2013-t) равно 1 при t между 1 января 2009 года и 1 января 2013 года и равно нулю вне этого интервала.

#### Как можно атаковать сеть?

Даже если злоумышленник преуспеет, это не приведёт к тому, что можно будет создавать деньги из воздуха, присваивать себе чужие монеты или вносить иные произвольные изменения. Узлы никогда не примут некорректную транзакцию или блок, её содержащий (потому что их много, друг с другом они не знакомы, и каждый принимает решение о принятии/непринятии самостоятельно). Атакующий может лишь пытаться изменить одну из своих транзакций, чтобы возвратить себе деньги. 

##### Стоимость покупки оборудования, составляющего 51% от мощности сети 

Оценим стоимость атаки 51% на текущий момент (ноябрь 2014 года). Планируемый KnC на третий квартал майнер Нептун будет выдавать минимум 3 THash/s при стоимости 6000$ за штуку. Мощность сети на сегодня составляет 240 PHash/s (а посмотреть актуальную всегда можно [здесь](https://blockchain.info/ru/charts/hash-rate?timespan=30days&showDataPoints=false&daysAverageString=1&show_header=true&scale=0&address=)). Как нетрудно вычислить, если в этот момент начать скупать новое спецоборудование, то для получения контроля над 51% от вычислительной мощности придётся купить его на 250 PHash/s. Т.е. придётся купить (250 PHash/s)/(3 THash/s) = 83333 таких специализированных устройств. Умножая это на стоимость одного устройства, получим итоговую себестоимость такой операции в долларах: 83333 ⋅ 6000$ = 500 million $. Этот расчёт довольно приблизителен (не учтены довольно ощутимые расходы на покупку блоков питания и соответствующей инфраструктуры + майнера ещё нет на рынке, спецификации могут несколько поменяться).

Есть, впрочем, мнение, что скупить все компании, производящие спецоборудование для майнинга, выйдет заметно дешевле. Тогда 
* в расчёты надо включать не цену для покупателя в 6000$ за майнер, а цену себестоимости 
* у такого владельца появляется возможность приостанавливать производство майнеров и делать различные объявления, которые будут влиять на курс.

##### Выгода атаки

Выгоде при атаке "двойной траты" монет потенциально ограничивается объёмом откатываемых транзакций. Если оборудование для атаки стоит 150 миллионов долларов (вместе с расходами на настройку и эксплуатацию), потребуется кинуть продавца или кучу продавцов на заметно большую сумму. Даже если случится чудо и удастся провести такой огромный объём (при том, что блокчейн мониторят на подобные всплески), возникнут трудности с отмыванием этих денег, с выводом в фиат, и к тому же курс надолго заваливается в разы.

##### Что нам хочется понять?

* понять, насколько злоумышленник может перерисовать блокчейн при том или ином количестве вычислительных мощностей, что конкретно он может сделать
* доказать, что в случае наличия у злоумышленника более чем половины вычислительной мощности сети ("51%") со 100%-ной вероятностью он сможет произвести двойную трату.
* исследовать вероятность успеха такой атаки при наличии меньшего количества вычислительной мощности — например, при 40%.


##### Теория


##### Решение задачи

Мы рассмотрим два случая. В первом из них мы будем считать, что злоумышленник до атаки майнил как честный майнер, постепенно наращивая контролируемые им мощности. Таким злоумышленником, например, могут быть несколько вступивших в сговор владельцев пулов, т.к. "честный" майнинг на пулах происходит всегда.

Во втором случае вычислительные мощности злоумышленника будут простаивать перед началом атаки, а в момент атаки будут резко запущены. Это возможно, если злоумышленник — долларовый мультимиллионер, решивший атаковать сеть, создавший для этого ферму и настроивший соло-майнинг. Ситуацию, при которой злоумышленник, обладающий большим процентом мощностей, резко подключился к какому-нибудь пулу, мы считаем невозможной (просто потому, что у него нет ни единой причины это делать).

Нам кажется, что в обоих случаях результаты будут примерно одинаковыми, но для полноты решения задачи мы рассмотрим оба. Понятно, что первый из них ближе к реальности — 1) моментальное увеличение хэшрэйта сети в два раза вызовет массу подозрений 2) чисто технически наращивать мощности постепенно проще, чем резко включить большое количество устройств.

Введём обозначения. Пусть `a` hash/s — вычислительная мощность злоумышленника, `b` hash/s — вычислительная мощность честных майнеров. Полный хэшрэйт сети перед началом атаки, в соответствии с нашим предположением, равен `a+b`.

###### Первый случай: злоумышленник наращивал вычислительные мощности, не прекращая майнить

###### Ситуация "последнее изменение сложности было давно, следующее тоже нескоро"

Изменение сложности в сети Биткойн происходит, как известно, каждые 2016 блоков. В этом подразделе мы рассматриваем случай, когда изменением сложности во время атаки можно пренебречь — т.е., к примеру, последнее изменение сложности было 1008 блоков назад, следующее будет спустя 1008 блоков.

Предположим, майнинг в течение ~2 недель до последнего пересчёта сложности происходил при среднем хэшрэйте `a+b` hash/s. Тогда при последнем пересчёте сложности она подстроилась так, чтобы нахождение блока при таком хэшрэйте в среднем занимало ровно 10 минут. Назовём эту сложность diff<sub>0</sub>. Запишем формулу, связывающую хэшрэйт майнера, сложность и ожидаемое время нахождения им блока, и её частный случай "майнер = вся сеть": 

hashrate = diff ⋅ 2<sup>32</sup>/time => a+b = diff<sub>0</sub> ⋅ 2<sup>32</sup>/600.

(Число "600" здесь означает 600 секунд = 10 минут. Единицы измерения — количество хэшей и секунды — опущены.)
Далее, общую формулу можно переписать в виде

time = diff ⋅ 2<sup>32</sup>/hashrate.

Она даёт ожидаемое (среднее) время нахождение блока. Время нахождения блока злоумышленником после начала атаки, таким образом, 

time_malicious = diff<sub>0</sub> ⋅ 2<sup>32</sup>/a = 600 c ⋅ (a+b)/a.

Время нахождения блока честными пользователями

time_legitimate = diff<sub>0</sub> ⋅ 2<sup>32</sup>/b = 600 c ⋅ (a+b)/b.

Если совокупная вычислительная мощность, контролируемая злоумышленником, больше совокупной вычислительной мощности честных майнеров (a>b), злоумышленник будет находить блоки в среднем быстрее. К примеру, если злоумышленником контролируется 60% мощности сети, а честными пользователями — 40%, time_malicious = 600 c ⋅ (1/0.6) = 1000 с = 16.6 минут, time_legitimate = 600 c ⋅ (1/0.4) = 1500 с = 25 минут. За то время, пока честные майнеры будут находить 4 блока, злоумышленник найдёт 6.

Но даже при a<b злоумышленнику может повезти так, что он победит.

###### Зачем продавцы ждут какое-то количество подтверждений перед отправкой товара?

Как уже было сказано ранее, истинной цепочкой в рамках протокола Биткойн считается цепочка блоков, суммарная сложность которой выше. Предположим, сложность во время атаки не меняется ("последнее изменение сложности было 1008 блоков назад, следующее будет спустя 1008 блоков"). Тогда можно говорить не о суммарной сложности, а просто сравнивать длины цепочек атакующего и "честных" майнеров.

Получатель ждет, пока транзакция не будет добавлена в блок и пока тот не будет продолжен еще z блоками. Матожидание количества блоков, добытых за то же время злоумышленником, равно ![МОЖ](http://latex.codecogs.com/gif.latex?%5Clambda%20%3D%20z%20%5Ccdot%20%5Cfrac%7Bq%7D%7Bp%7D)

Количество же добытых им блоков подчиняется распределению Пуассона и равно

![Количество добытых злоумышленником блоков](http://latex.codecogs.com/gif.latex?P%28k%29%20%3D%20%5Cfrac%7B%5Clambda%5Ek%7D%7Bk%21%7D%20e%5E%7B-%5Clambda%7D)

Гонку между честными участниками и злоумышленником можно представить как биномиальное случайное блуждание. Успешное событие, когда <<хорошая>> цепь удлиняется на один блок, приводит к увеличению отрыва на единицу, а неуспешное, когда очередной блок создает злоумышленник,—  к его сокращению. Вероятность атакующего наверстать разницу в несколько блоков такая же, как и в задаче о <<разорении игрока>>. Представим, что игрок имеет неограниченный кредит, начинает с некоторым дефицитом и у него есть бесконечно много попыток, чтобы отыграться.

Рассмотрим теперь, как долго получателю платежа стоит ждать, прежде чем он будет полностью уверен, что бывший владелец не сможет отменить транзакцию. Мы предполагаем, что злоумышленник-отправитель позволяет адресату некоторое время верить, что платеж был проведен, после чего возвращает деньги себе. Получатель узнает об этом, но мошенник надеется, что будет уже слишком поздно. Адресат создает новую пару ключей и сообщает свой публичный ключ отправителю прямо перед подписанием транзакции. Это не позволит отправителю заранее начать работать над цепочкой и провести транзакцию в тот момент, когда он будет достаточно удачлив, чтобы совершить рывок вперед. После отправки платежа мошенник начинает втайне работать над параллельной версией цепочки, содержащей альтернативную транзакцию. Получатель ждет, пока транзакция не будет добавлена в блок и пока тот не будет продолжен еще z блоками.


Пусть количество блоков, на которые отстаёт злоумышленник, равно `gap`. Слово "отстаёт" здесь значит вот что: когда честные майнеры майнят блок номер 280005, злоумышленник вполне может начать майнить свой форк с блока номер 279998, и тогда `gap` = 7. Вычислим, на каком блоке он перегонит честных майнеров и тем самым победит. "Скорость" злоумышленника равна 1 блок/(600 c ⋅ (a+b)/a) = (1/600) ⋅ a/(a+b) блоков/с; скорость цепи, на которой майнят честные пользователи — (1/600) ⋅ b/(a+b) блоков/с. Пусть для краткости скорость злоумышленника v<sub>a</sub>, скорость честных — v<sub>b</sub>, тогда 

v<sub>a</sub> ⋅ time_attack - v<sub>b</sub> ⋅ time_attack = gap;
return v<sub>b</sub> ⋅ time_attack

Т.е., с начала атаки с точки зрения честных майнеров пройдёт вот сколько блоков: v<sub>b</sub> ⋅ gap/(v<sub>a</sub> - v<sub>b</sub>) = (b/(a+b)) ⋅ gap/((a/(a+b)) - (b/(a+b))) = b ⋅ gap/(a - b) = gap/(a/b - 1).

Что мы видим? Мы видим, что чем "глубже" начинал свой форк злоумышленник, тем дольше он будет обгонять основную цепь (что совершенно очевидно и без того). Если a<b, злоумышленник "в среднем" (т.е. со 100%-вероятностью) не обгонит честных майнеров никогда, что и видно из формулы (). 

###### Ситуация "атака начинается незадолго до изменения сложности"


###### Ситуация "атака начинается через малое время после изменения сложности"

###### Второй случай: злоумышленник резко запустил свои вычислительные мощности, а до этого они простаивали

##### Остающиеся вопросы

Хотелось бы понять, насколько злоумышленник может перерисовать блокчейн при том или ином количестве вычислительных мощностей. Правильно ли я понимаю, что:

*1. даже при 90% вычислительных мощностей у злоумышленника при децентрализованном хранении фулл-нод блокчейна (как сейчас: 7000 анонимных держателей полной ноды, блокчейн весит не терабайты) абсолютно единственное, что может делать злоумышленник – атака “платим, продавец ждёт 6 подтверждений, получаем digital good, делаем форк, обгоняем ветку, в которой была транзакция с нашей оплатой – всё, оплаты не было”? Какие ещё интересные штуки может вытворять злоумышленник? Принципиально не включать транзакции неугодных лиц – так оставшиеся 10%, находя блоки, будут включать.*

*2. при 49% вычислительных мощностей у злоумышленника он не может сделать вообще ничего – даже если он сделает форк, ему несколько раз повезёт и он таки обгонит блокчейн “честных майнеров” на небольшое время, продавцы моментально об этом узнают и прекратят продажи товаров?*

*3. при 0% вычислительных мощностей и 80% контролируемых полных нод (в ситуации, когда блокчейн стал весить 100 Тб и его хранят только некоторые фирмы (надеюсь, до этого не дойдёт)) может ли злоумышленник перерисовать блокчейн вообще как хочет?*

#### Дальнейшее чтение

* Bitcoin Mining Explained Like You're Five: [часть 1](http://chrispacia.wordpress.com/2013/09/02/bitcoin-mining-explained-like-youre-five-part-1-incentives/), [часть 2](http://chrispacia.wordpress.com/2013/09/02/bitcoin-mining-explained-like-youre-five-part-2-mechanics/), [часть 3](http://chrispacia.wordpress.com/2013/09/07/bitcoin-cryptography-digital-signatures-explained/), [часть 4](http://chrispacia.wordpress.com/2013/09/29/bitcoin-explained-like-youre-five-part-4-securing-your-wallet/), [часть 5](http://chrispacia.wordpress.com/2014/02/08/bitcoin-explained-like-youre-five-part-5-macroeconomics/)